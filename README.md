# Minimalistic Microservice Framework

This documentation is written along the guidelines of educational grade documentation discussed in the 
[infracamp](https://github.com/infracamp/infracamp/blob/master/DOCUMENTATION_GUIDE.md) project. Please ask and
document issues.

## Goals

- Minimal Footprint
- No external dependencies
- Clear and small stack trace
- Fluent Api
- Role-Based Authentication

## Quickstart

```index.php:```
```php
$app = new App();
$app->acl->addRule(aclRule()->ALLOW());                     // Allow all requests

$app->router
    ->get("/",                                              // Define a Action for HTTP-GET-Requests to /
        function() use ($app) {                             
            $app->out("Hello World");                       // Hello World!
            return true;                                    // Important: Return true if output was already sent.
        }
    );
    
$app->serve();                                              // Run the App
```

## Installation

We suggest using [composer](http://getcomposer.com):

```
composer require phore/micro-app
``` 

## [ACL (Access Control Lists / Firewall)](doc/acl/acl.md) *([Example](doc/acl/acl.php), [FAQ](doc/acl/acl-faq.md))*


***Access Control Lists*** define which User/IP may access which route in
your application. It will initiate the Authentication Process (see Authentication)
or reject the request.

ACLs will be processed from top to bottom. The first rule that matches the request
will win.

### Examples

- ***ALLOW*** if route matches `/api/admin/*` ***AND*** role matches `@admin` ***AND*** network matches `10.0.0.0/8`:
    ```php
    $app->acl->addRule(aclRule()->route("/api/admin/*")->role("@admin")->network("10.0.0.0/8")->ALLOW());
    ```

- ***ALLOW*** access to routes `/admin/*` if authenticated user is in `@admin`-group:
    ```php
    $app->acl->addRule(aclRule()->route("/admin/*")->role("@admin")->ALLOW());
    ```


***By default phore-micro-app will deny all requests. So you have to specify explicitly
which requests to allow***

## [Routing](docs/router/routing.md) *([Example](docs/router/routing-example.php))*

Define routes (Path) and connect them to controller functions:

- Execute the function if the browser hits `http://domain.xy/hello/world`:
  ```php
  $app->router->get("/hello/world", function() {
      echo "Hello World";
      return true; 
  });
  ```
  
- Define Parameters (Prefix `:`) and optional parameters (`?`) in Routes:
  ```php
  $app->router->get("/api/create/:userId/:userName?", function(RouteParams $routeParams) {
      echo "Hello {$routeParams->get("userId")} - {$routeParams->get("userName", 'Default Username')}";
      return true;
  });
  ```
  *`$routeParams`* is automaticly generated by Dependency injection.
  
- Delegate a request to a separate class: [see Example](doc/router/routing-delegate-example.php)
  ```php
  $app->router->delegate("/admin/*", AdminController::class);
  ```

Parameters at controller function are generated by Dependency Injection
and may contain any service defined in DiContainer.

Request specific parameters are:

| Parameter Name | ClassName        | Description                   |
|----------------|------------------|-------------------------------|
| `$request`     | `Request`        | The full request object       |
| `$route`       | `Route`          | The current route object      |
| `$routeParams` | `RouteParams`    | Container with parameters     |
| `$GET`         | `QueryParams`    | Query parameters              |
| `$POST`        | `QueryParams`    | Parameters send by HTTP-POST  |


## Assets *([Example](doc/assets/assets.php))*

Assets are located below the `/assets/`-route. You can define one or
more directories, the asset-manager will try to find the asset.

`/assets/*` will be allowed for all requests in ACL. So don't put
sensitive data here.

- Allow all requests to `/asset/*` and link them to local assets:
  ```php
  $app->assets()->addAssetSearchPath(__DIR__ . "/asset_data/");
  $app->assets()->addAssetSearchPath(__DIR__ . "/alt_asset_data/");
  ```
  Request to `/asset/css/some.css`: The asset-manager will try to
  find the file in `/asset_data/css/some.css`. If it does not exist there,
  it will try to find in `/alt_esset_data/css/some.css`
  
- Virtual assets are generated on the fly.
  ```php
  $app->assets()->addVirtualAsset("all.js", [__DIR__ . "/some/file.js", __DIR__ . "/some/other.js"]);
  ``` 
  The virtual asset is available in path `/asset/all.js`.


## Dependency Injection

The app-class is a dependency injection container. You can register
values or services using the `define()` method.

- Define a value to property `version`:
  ```php
  $app->define("version", new DiValue("1.0.1"));
  echo $app->version;
  ```
  
- Define a factory to property `configFile`:
  ```php
  $app->define("configFile", new DiService(function() {
      return file_get_contents("config-file.json") 
  });
  echo $app->configFile;
  ```

## Error Handling

The system has build-in functions for error-handling:

- Activate `json` error/exception handling:
  ```
  $app->setOnExceptionHandler(new JsonExceptionHandler());
  ```

## API Usage: Default Result Handler

Instead of formating the Result your own, the framework uses a
result-handler to format results returned by `return` in controller.

```
$app->setDefaultResultHandler(new JsonResultHandler());
```

in the controller you can then just return the data:

```php
$app->get("/", function() {
    return ["data"=>"someData"];
}
```


## Authentication & Authorization

- Use `BasicUserProvider` to load users from a yaml-file (see [user-passwd.yml](doc/acl/user-passwd.yml))
    ```php
    $app->authManager->setUserProvider($basicUserProvider = new BasicUserProvider());
    $basicUserProvider->addUserYamlFile(__DIR__ . "/../user-passwd.yml");
    ```
- Create secure and salted SHA-512 passwords:
  ```bash
  mkpasswd -m sha-512
  ```


## Role based Authentication

Predefined Group hierachy:

- Highest Priority `@owner` => `@admin` => `@member` => `@user` Lowest Priority
                            